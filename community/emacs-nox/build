#!/bin/sh -e

./configure \
    --prefix=/usr \
    --with-modules \
    --without-all \
    --without-x \
    --with-x-toolkit=no \
    --with-x=no \
    --with-gnutls=yes \
    --with-xml2=yes

mkdir -p "$1/usr/share/emacs/site-lisp"
cat << EOF > "$1/usr/share/emacs/site-lisp/site-start.el"
;; Improve startup time
(setq gc-cons-threshold 50000000
      package-enable-at-startup nil)

;; Fix ugly
(menu-bar-mode -1)

;; Better security defaults
(with-eval-after-load 'gnutls
  (setq
   gnutls-verify-error t
   gnutls-min-prime-bits 2048
   gnutls-trustfiles '("/etc/ssl/cert.pem")))

;; Better defaults when inside an X11 terminal
(when (getenv "DISPLAY")
  ;; Enable X11 mouse features
  (xterm-mouse-mode 1)

  ;; Use xsel and the X11 clipboard
  (when (executable-find "xsel")
    (setq x-select-enable-clipboard t)
    (defun xsel-cut-function (text &optional push)
      (with-temp-buffer
        (insert text)
        (call-process-region (point-min) (point-max) "xsel" nil 0 nil "--clipboard" "--input")))
    (defun xsel-paste-function()
      (let ((xsel-output (shell-command-to-string "xsel --clipboard --output")))
        (unless (string= (car kill-ring) xsel-output)
          xsel-output )))
    (setq interprogram-cut-function 'xsel-cut-function)
    (setq interprogram-paste-function 'xsel-paste-function)))
EOF

make
make DESTDIR="$1" install
